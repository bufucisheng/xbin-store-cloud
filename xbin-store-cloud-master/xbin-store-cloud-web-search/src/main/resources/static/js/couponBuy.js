/* product-search/1.0.2 couponBuy.js Date:2016-12-08 17:27:35 */
sdefine("js/couponBuy.js",["js/trimPath.js","js/dialog.js","js/cart.js"],function(require,a){require("j/trimPath.js"),require("js/dialog.js");var c={0:"\u4eac\u4e1c\u4e3b\u7ad9",1:"\u4eac\u4e1c\u5ba2\u6237\u7aef",2:"\u5168\u5e73\u53f0",3:"M\u7aef",4:"\u624b\u673aQQ",5:"\u5fae\u4fe1",6:"QQ\u6d4f\u89c8\u5668",7:"\u4eac\u81f4\u8863\u6a71"};var d='<div class="w"><div id="floatbar-cart" class="floatbar-cart">	<div class="floatbar-bd">		<span class="slider-prev slider-disable"></span>		<span class="slider-next"></span>		<div class="floatbar-slider">			<ul class="flbar-slider-goods J-slider-ul">				</ul>		</div>	</div>	<div class="floatbar-ft">		<div class="floatbar-coupon {if coupon.couponType != 0 && coupon.couponType != 1} flbar-coupon-03 {/if} {if coupon.couponType == 0} flbar-coupon-02 {/if}">			<div class="coupon-inner">				<div class="flbar-coupon-info">             </div>			</div>		</div>		<div class="floatbar-checkout">			<i class="bd-arrow"></i>			<div class="checkout-info">				<span class="goods-trigger J-flbarbd-trigger"><em class="goods-total">\u5df2\u9009\u62e9<b class="num">0</b>\u4ef6\u5546\u54c1</em><i class="arrow"></i></span>				<span class="price-total"><em class="label">\u603b\u4ef7</em><strong class="price">\xa50</strong></span>				</div>			<a href="//cart.jd.com/cart.action" class="btn-checkout">\u53bb\u8d2d\u7269\u8f66\u7ed3\u7b97</a>			<div class="m-quicktip checkout-tip hide">				<span class="tip-inner"><i class="tip-icon"></i><em class="tip-title">\u6ca1\u6709\u5546\u54c1 \u5feb\u53bb\u6311\u6311</em></span>			</div>		</div>	</div></div></div>';var e='{for sku in skus}<li class="J-slider-li">	<div class="p-img"><a href="//item.jd.com/${sku.Id}.html" target="_blank"><img src="//img13.360buyimg.com/n4/s80x80_${sku.ImgUrl}" alt="${sku.Name}"></a></div>	<div class="p-name"><a href="//item.jd.com/${sku.Id}.html" title="${sku.Name}" target="_blank">${sku.Name}</a></div> <div class="p-param"></div>	<div class="p-price"><span class="p-stock">x${sku.Num}</span><strong class="price">\xa5${sku.PromotionPrice}</strong></div></li>{/for}';var f;var g=$(window);var h;var i;var j;var k;var l;var m=null;var n=require("product/module/cart.js");function o(a){a&&a.coupon&&(k=a.coupon,$(d.process({coupon:k})).insertAfter("#J_searchWrap"),h=$("#floatbar-cart"),f=h.closest(".w"),i=h.find(".goods-total .num"),j=h.find(".price-total .price"),l=$(".floatbar-bd").switchable({type:"slider",mainClass:"J-slider-li",contentClass:"J-slider-ul",speed:600,step:5,hasPage:!0,prevClass:"slider-prev",nextClass:"slider-next",includeMargin:!0,autoLock:!0,pagCancelClass:"slider-disable"}),$(window).bind("resize",function(){y()}),s(k),t(k),q(),$.browser.isIE6()||(r(),g.bind("scroll resize",function(){r()})),$(".J-flbarbd-trigger").bind("click",function(){h.toggleClass("z-flbar-showbd")}),$("#J_searchWrap").delegate(".addcart","click",function(a){a.preventDefault();var b=$(this);if(!b.hasClass("disabled")){var c=b.siblings(".focus").data("sku");var d=n.addToCart(c);d.then(function(a){a&&1==a.rcd?p(b,!0):a&&2==a.rcd?p(b,!1,"\u6dfb\u52a0\u5546\u54c1\u5931\u8d25\uff0c\u5df2\u8d85\u51fa\u8d2d\u7269\u8f66\u6700\u5927\u5bb9\u91cf"):p(b,!1)},function(){p(b,!1)}),d.then(q)}}),h.find(".btn-checkout").bind("click",function(a){"0"==$.trim(i.text())&&(a.preventDefault(),h.find(".m-quicktip").show().delay(1500).fadeOut()),4===k.couponPlatform||5===k.couponPlatform?(a.preventDefault(),$("body").dialog({title:null,width:514,type:"html",extendMainClass:"tipwrap-conpon",source:'<div class="m-tip3">  <div class="tip-hd">  	<i class="tip-icon"></i>      <em class="tip-title">\u6b64\u4f18\u60e0\u5238\u53ea\u80fd\u5728\u5fae\u4fe1\u8d2d\u7269/QQ\u8d2d\u7269\u4f7f\u7528\u63a8\u8350\u4f7f\u7528\u624b\u673a\u6253\u5f00\u5fae\u4fe1\u8d2d\u7269\u67e5\u770b</em>  </div>  <div class="tip-bd">  	<div class="coupon-imgshow">  		<img src="//misc.360buyimg.com/product/search/0.0.17/css/i/temp/imgshow-wx.jpg" alt="" />  	</div>  	<div class="tip-btnbox">  		<a href="" class="btn-ok">\u786e\u5b9a</a>  	</div>  </div></div>',onReady:function(){this.el.find(".btn-ok").bind("click",function(a){a.preventDefault(),a.stopPropagation(),$.closeDialog()})}})):7===k.couponPlatform?(a.preventDefault(),$("body").dialog({title:null,width:514,type:"text",extendMainClass:"tipwrap-conpon",source:'<div class="m-tip3">  <div class="tip-hd">  	<i class="tip-icon"></i>      <em class="tip-title">\u6b64\u4f18\u60e0\u5238\u53ea\u80fd\u5728\u4eac\u81f4\u8863\u6a71\u5ba2\u6237\u7aef\u4f7f\u7528\uff0c\u63a8\u8350\u4f7f\u7528\u624b\u673a\u6253\u5f00\u67e5\u770b</em>  </div>  <div class="tip-bd">  	<div class="coupon-imgshow">  		<img src="//misc.360buyimg.com/product/search/0.0.17/css/i/temp/imgshow-jzyc.jpg" alt="" />  	</div>  	<div class="tip-btnbox">  		<a href="" class="btn-ok">\u786e\u5b9a</a>  	</div>  </div></div>',onReady:function(){this.el.find(".btn-ok").bind("click",function(a){a.preventDefault(),a.stopPropagation(),$.closeDialog()})}})):(1===k.couponPlatform||3===k.couponPlatform)&&(a.preventDefault(),$("body").dialog({title:null,width:514,type:"text",extendMainClass:"tipwrap-conpon",source:'<div class="m-tip3">  <div class="tip-hd">  	<i class="tip-icon"></i>      <em class="tip-title">\u6b64\u4f18\u60e0\u5238\u53ea\u80fd\u5728\u4eac\u4e1cApp/\u4eac\u4e1cM\u7248\u4f7f\u7528\uff0c\u63a8\u8350\u4f7f\u7528\u624b\u673a\u6253\u5f00\u4eac\u4e1cApp\u67e5\u770b</em>  </div>  <div class="tip-bd">  	<div class="coupon-imgshow">  		<img src="//misc.360buyimg.com/product/search/0.0.17/css/i/temp/imgshow-app.jpg" alt="" />  	</div>  	<div class="tip-btnbox">  		<a href="" class="btn-ok">\u786e\u5b9a</a>  	</div>  </div></div>',onReady:function(){this.el.find(".btn-ok").bind("click",function(a){a.preventDefault(),a.stopPropagation(),$.closeDialog()})}}))}))}function p(a,b,c){var d=a.offset();var e;b?(c=c||"\u52a0\u5165\u8d2d\u7269\u8f66\u6210\u529f",e='<div class="m-quicktip"><span class="tip-inner tip-success"><i class="tip-icon"></i><em class="tip-title">'+c+"</em></span></div>"):(c=c||"\u52a0\u5165\u8d2d\u7269\u8f66\u5931\u8d25",e='<div class="m-quicktip"> <span class="tip-inner tip-error"><i class="tip-icon"></i><em class="tip-title">'+c+"</em></span> </div>");var f=$(e).css({position:"absolute",top:d.top-50,left:d.left-27,"z-index":20});$("body").append(f),f.delay(1500).fadeOut()}function q(){n.getCart().then(u)}a.init=o;function r(){g.scrollTop()+g.height()<f.offset().top?h.addClass("z-flbar-fixed"):h.removeClass("z-flbar-fixed")}function s(a){var b=null;1===a.couponType&&(b='<span class="amount"><span class="unit">\xa5</span><strong>'+a.discount+'</strong><span class="text">\u6ee1'+a.quota+"\u53ef\u7528</span></span>"),b&&h.find(".flbar-coupon-info").html(b)}function t(a){var b=[];var c=[];1===a.couponLimitType&&(b.push("\u9650\u54c1\u7c7b"),c.push('<div class="item"><div class="title">\u9650\u54c1\u7c7b</div>'+a.couponLimitInfo+"</div>")),a.couponLimitType&&1!==a.couponLimitType&&(b.push("\u9650\u5e97\u94fa"),c.push('<div class="item"><div class="title">\u9650\u5e97\u94fa</div>'+a.couponLimitInfo+"</div>")),z(a)&&(b.push("\u9650\u5e73\u53f0"),c.push('<div class="item"><div class="title">\u9650\u5e73\u53f0</div>'+z(a)+"</div>")),2===a.couponAreaType&&(b.push("\u9650\u533a\u57df"),c.push('<div class="item"><div class="title">\u9650\u533a\u57df</div>'+a.couponAreaDesc+"</div>")),b.length>0&&(h.find(".flbar-coupon-info").append('<span class="limit">'+b.join(" ")+"</span>"),h.find(".coupon-inner").append('<div class="flbar-coupon-detail"> <i class="arrow"><b class="layer1"></b><b class="layer2"></b></i>'+c.join("")+"</div>"),h.find(".coupon-inner").hover(function(){$(this).addClass("z-limit-show")},function(){$(this).removeClass("z-limit-show")}))}function u(a){if(a.Cart){var b=w(a.Cart);m=b,$.get("/coupon.php?type=cart&sku="+b.skuString+"&coupon_batch="+k.batchId).then(v)}}function v(a){var b=0;var c=0;var d=[];a&&0!=$.trim(a).length||(a="[]"),$.each($.parseJSON(a),function(a,e){var f=m.skus[e];f&&"1"==f.CheckType&&(b+=f.Num,c+=f.PromotionPrice*f.Num,d.push(f))}),h.find(".flbar-slider-goods").html(e.process({skus:d})),y(),i.text(b),j.text("\xa5"+c.toFixed(2).replace(/\.00$/,""))}function w(a){var b;var c={skus:{},skuString:""};for(b in a)a.hasOwnProperty(b)&&(("ManJian"==b||"ManZeng"==b||"TheSuit"==b)&&$.each(a[b],function(a,b){$.each(b.Skus,function(a,b){c.skus[b.Id]=x(b),c.skuString+=[b.Id,b.Cid,$.trim(b.VenderId)||"8888"].join("_")+","})}),("TheSkus"==b||"TheGifts"==b)&&$.each(a[b],function(a,b){c.skus[b.Id]=x(b),c.skuString+=[b.Id,b.Cid,$.trim(b.VenderId)||"8888"].join("_")+","}));return c}function x(a){var b={};return a.MainSKU?(b.ImgUrl=a.MainSKU.ImgUrl,b.Name=a.MainSKU.Name):(b.ImgUrl=a.ImgUrl,b.Name=a.Name),b.CheckType=a.CheckType,b.Id=a.Id,b.Num=a.Num,b.PromotionPrice=a.PromotionPrice,b}function y(){var a=$(window).width();var b=0;b=1210>a?3:a>=1210&&1390>a?4:5,l.update(function(){l.options.step=b,l.options.visible=b})}function z(a){var b=[];return a.platformDetailDesc?a.platformDetailDesc:a.platformDetails&&a.platformDetails.length>0?($.each(a.platformDetails,function(a,d){c[d.platformType]&&b.push(c[d.platformType])}),"\u4ec5\u9650"+b.join("\u3001")+"\u5e73\u53f0\u4f7f\u7528"):null}});
