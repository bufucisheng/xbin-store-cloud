/* product-m/1.0.0 p-contrast.js Date:2016-07-07 17:12:28 */
define("js/p-contrast.js",["js/switchable.js","js/trimPath.js"],function(require,a,b){require("js/switchable.js");require("js/trimPath.js");var e=function(){var a,b=3,c=document.createElement("div"),d=c.getElementsByTagName("i");for(;c.innerHTML="<!--[if gt IE "+ ++b+"]><i></i><![endif]-->",d[0];);return b>4?b:a}();var f={getPriceNum:function(a,b,c,d){a="string"==typeof a?[a]:a,b=b||$("body"),c=c||"J-p-",$.ajax({url:"//p.3.cn/prices/mgets?skuIds=J_"+a.join(",J_")+"&type=1",dataType:"jsonp",success:function(a){if(!a&&!a.length)return!1;for(var e=0;e<a.length;e++){var f=a[e].id.replace("J_","");var g=parseFloat(a[e].p,10);b.find("."+c+f).html(g>0?"\uffe5"+a[e].p:"\u6682\u65e0\u62a5\u4ef7"),"function"==typeof d&&d(f,g,a)}}})},TPL:{contrast:'<div id="pop-compare" data-load="false" class="pop-compare'+(pageConfig.wideVersion&&pageConfig.compatible?"":" pop-compare-narrow")+'"><div class="pop-wrap"><p class="pop-compare-tips"></p><div class="pop-inner"><div class="diff-hd"><ul class="tab-btns clearfix"><li class="current ui-switchable-item"><a href="javascript:;">\u5bf9\u6bd4\u680f</a></li><li class="ui-switchable-item"><a href="javascript:;">\u6700\u8fd1\u6d4f\u89c8</a></li></ul><div class="operate"><a href="javascript:;" class="hide-me">\u9690\u85cf</a></div></div><div class="diff-bd tab-cons"><div class="tab-con ui-switchable-panel"><div id="diff-items" class="diff-items clearfix"><dl class="item-empty"><dt>1</dt><dd>\u60a8\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u6dfb\u52a0</dd></dl><dl class="item-empty"><dt>2</dt><dd>\u60a8\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u6dfb\u52a0</dd></dl><dl class="item-empty"><dt>3</dt><dd>\u60a8\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u6dfb\u52a0</dd></dl><dl class="item-empty"><dt>4</dt><dd>\u60a8\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u6dfb\u52a0</dd></dl></div><div class="diff-operate"><a target="_blank" id="goto-contrast" href="#none" class="btn-compare-b">\u5bf9\u6bd4</a><a class="del-items">\u6e05\u7a7a\u5bf9\u6bd4\u680f</a></div></div><div class="tab-con ui-switchable-panel tab-scroll" style="display:none;"><div class="scroll-item ui-switchable-panel-body clearfix"><span id="sc-prev" class="scroll-btn sb-prev">&lt;</span><span id="sc-next" class="scroll-btn sb-next">&gt;</span><div class="scroll-con clearfix"><ul id="scroll-con-inner" class="ui-switchable-panel-main"><p class="scroll-loading ac">\u8f7d\u5165\u4e2d...</p></ul></div></div></div></div></div></div></div>',item:'<dl class="hasItem" id="cmp_item_${sku}" fore="${ind}">  <dt>      <a target="_blank" href="//item.jd.com/${data[sku].skuId}.html"><img src="${pageConfig.FN_GetImageDomain(data[sku].skuId)}n5/${data[sku].imagePath}" width="50" height="50"></a>  </dt>  <dd>      <a target="_blank" class="diff-item-name" href="//item.jd.com/${data[sku].skuId}.html">${data[sku].name}</a>      <span class="p-price"><strong class="J-p-${data[sku].skuId}"></strong><a class="del-comp-item" skuid="${data[sku].skuId}">\u5220\u9664</a></span>  </dd></dl>',recentItem:'{for item in data}<li id="rec_item_${item.sku}" class="ui-switchable-panel" data-push="${pageConfig._contrast.push(item.sku)}"><div class="rec_item_wrap">  <div class="dt">      <a target="_blank" href="//item.jd.com/${item.sku}.html"><img src="${pageConfig.FN_GetImageDomain(item.sku)}n5/${item.img}" width="50" height="50"></a>  </div>  <div class="dd">      <a target="_blank" href="//item.jd.com/${item.sku}.html" class="diff-item-name">${item.t}</a>      <div class="btns clb">          <span class="p-price"><strong class="J-p-${item.sku}"></strong></span>          <a id="recent_${item.sku}" data-recent="true" data-sku="${item.sku}" skuid="${item.sku}" class="J_contrast btn-compare btn-compare-s"><span>\u5bf9\u6bd4</span></a>      </div>  </div></div></li>{/for}'},init:function(a,b,c){return this.cookieName=b||"_contrast",this.recentCharset=c||"utf-8",this.bindEvent("cmpBtn").btnStyle(null,"set"),"side"==readCookie(this.cookieName+"_status")&&$("#side-cmp").length<1?$("#sidepanel").prepend('<span id="side-cmp"><a class="compareHolder" href="javascript:;"><b></b>\u5bf9\u6bd4\u680f</a></span>'):readCookie(this.cookieName)&&this.showPopWin(null),this.bindEvent("showWin"),this.domain=pageConfig.FN_getDomain(),"1"==$("#J_goodsList").find("ul.gl-warp").attr("data-tpl")&&$("#backtop").prepend('<div class="b-item"><a class="b-i-contrast" href="#none">\u5546\u54c1\u5bf9\u6bd4</a></div>'),this},bindEvent:function(a){var d=($(".J_contrast"),$(".del-items"),this);return"cmpBtn"==a&&$("body").undelegate(".J_contrast","click").delegate(".J_contrast","click",function(a){a.preventDefault();var b=$(this).attr("data-sku"),c=readCookie(d.cookieName)||"",e=c.split(".").length;4>e?(d.showPopWin(b),"true"==$(this).attr("data-recent")&&d.switchTab(0)):d.hasCookie(b)?("true"==$(this).attr("data-recent")&&d.switchTab(0),d.showPopWin(b)):(d.showPopWin(null),d.setMessage("\u5bf9\u6bd4\u680f\u5df2\u6ee1\uff0c\u60a8\u53ef\u4ee5\u5220\u9664\u4e0d\u9700\u8981\u7684\u680f\u5185\u5546\u54c1\u518d\u7ee7\u7eed\u6dfb\u52a0\u54e6\uff01"))}),"delAll"==a&&$("body").undelegate(".del-items","click").delegate(".del-items","click",function(){d.delContrastItem(null,!0),$("#goto-contrast").attr("href","#none")}),"delHover"==a&&($(".hasItem").hover(function(){$(this).find(".del-comp-item").css("visibility","visible")},function(){$(this).find(".del-comp-item").css("visibility","hidden")}),$(".hasItem .del-comp-item").bind("click",function(){var a=$(this).attr("skuid");d.delContrastItem(a)}),$("#goto-contrast").click(function(){var a=readCookie(d.cookieName)||"",b=a.split(".");if(b.length<2)return d.setMessage("\u81f3\u5c11\u6709\u4e24\u4ef6\u5546\u54c1\u624d\u80fd\u5bf9\u6bd4\u54e6\uff01"),!1;var c=[0,0,0,0];for(var e=0;e<b.length;e++)c[e]=b[e];$("#goto-contrast").attr("href","//www.jd.com/compare/"+c.join("-")+".html")})),"hide"==a&&$("body").undelegate(".diff-hd .hide-me","click").delegate(".diff-hd .hide-me","click",function(){d.hidePopWin()}),"showWin"==a&&$("body").delegate(".b-i-contrast","click",function(){d.showPopWin(null,!0)}),this},switchTab:function(a){$(".diff-hd li").eq(a).trigger("click")},btnStyle:function(a,b){if(a)"set"==b&&($(".J_contrast").filter('[data-sku="'+a+'"]').addClass("selected"),$("#comp_"+a+",#recent_"+a).addClass("btn-compare-s-active"),$("#cmp_"+a).text("\u53d6\u6d88\u5bf9\u6bd4")),"del"==b&&($(".J_contrast").filter('[data-sku="'+a+'"]').removeClass("selected"),$("#comp_"+a+",#recent_"+a).removeClass("btn-compare-s-active"),$("#cmp_"+a).text("\u52a0\u5165\u5bf9\u6bd4"));else{var c=readCookie(this.cookieName)||"";if(c=c.split("."),c.length<5)for(var d=0;d<c.length;d++)"set"==b&&($(".J_contrast").filter('[data-sku="'+c[d]+'"]').addClass("selected"),$("#comp_"+c[d]+",#recent_"+c[d]).addClass("btn-compare-s-active"),$("#cmp_"+c[d]).text("\u53d6\u6d88\u5bf9\u6bd4")),"del"==b&&($(".J_contrast").filter('[data-sku="'+c[d]+'"]').removeClass("selected"),$("#comp_"+c[d]+",#recent_"+c[d]).removeClass("btn-compare-s-active"),$("#cmp_"+c[d]).text("\u52a0\u5165\u5bf9\u6bd4"))}return this},loadExistList:function(a){var b=readCookie(this.cookieName)||"";b=b.split(".");for(var c=0;c<b.length;c++)this.setContrastItem(b[c]),c+1==b.length?this.setContrastItem(b[c],a):this.setContrastItem(b[c])},showPopWin:function(a){var c=$("#pop-compare"),d=this;a=a||null,$("#pop-compare").length<1&&$("body").append(this.TPL.contrast),$("#diff-items .hasItem").length<1&&(readCookie(this.cookieName)?this.loadExistList(function(){d.hasCookie(a)?d.delContrastItem(a):d.setContrastItem(a)}):d.setContrastItem(a)),"false"==$("#pop-compare").attr("data-load")?($("#pop-compare").show(),c.attr("data-load","true"),$("#pop-compare").switchable({delay:0,navSelectedClass:"current",event:"click",callback:function(a){1==a&&$(".scroll-loading").length>0&&d.getRecent(function(a){d.setRecentScroll(),d.getPriceNum(a,$("#pop-compare"),null,function(){})})}}),6!==e&&$("#pop-compare").animate({bottom:0},100)):("side"==readCookie(d.cookieName+"_status")&&($("#pop-compare").show().attr("data-load","true"),6!==e&&$("#pop-compare").show().animate({bottom:0}),createCookie(d.cookieName+"_status","show",30,"/;domain="+this.domain)),d.hasCookie(a)?d.delContrastItem(a):d.setContrastItem(a)),d.bindEvent("delAll").bindEvent("hide")},hidePopWin:function(){var a=this;if($("#side-cmp").length<1&&$("#sidepanel").prepend('<span id="side-cmp"><a class="compareHolder" href="javascript:;"><b></b>\u5bf9\u6bd4\u680f</a></span>'),6==e)$("#pop-compare").hide();else{if($(".pop-wrap").is(":animated"))return!1;$("#pop-compare").css("overflow","hidden").find(".pop-wrap").animate({left:"990px"},100,function(){$("#pop-compare").removeAttr("style").css({overflow:"visible",bottom:"-200px"}).hide().find(".pop-wrap").removeAttr("style").css("left",0)})}a.bindEvent("showWin"),createCookie(a.cookieName+"_status","side",30,"/;domain="+this.domain)},setContrastItem:function(a,b){var c=$("#pop-compare"),d=readCookie(this.cookieName)||"",f=(d.split(".").length,this);if(f.hasCookie(a)&&"true"==c.attr("data-load"))f.delContrastItem(a);else{if(!a)return!1;$.ajax({url:"//d.jd.com/ware/history?ids="+a,dataType:"jsonp",success:function(d){var e=$("#diff-items dl").index($("#diff-items").find(".item-empty").eq(0));var g={data:d,sku:a,ind:e};($("#cmp_item_"+a).length<1||!f.hasCookie(a))&&(c.find(".item-empty").eq(0).replaceWith(f.TPL.item.process(g)),f.getPriceNum(a,$("#pop-compare"),null,function(){})),f.bindEvent("delHover").setCookie(a).btnStyle(a,"set"),createCookie(f.cookieName+"_status","show",30,"/;domain="+f.domain),"function"==typeof b&&b(),f.setContrastBtn("add"),$("#pop-compare").attr("data-load","true")}})}return this},setContrastBtn:function(a){var b=readCookie(this.cookieName)||"",c=b.split(".").length;"add"==a&&c>1&&$("#goto-contrast").addClass("compare-active"),"reduce"==a&&2>c&&$("#goto-contrast").removeClass("compare-active")},sortList:function(){var a=$("#diff-items"),b=[];a.find(".hasItem").each(function(){b.push($(this).clone())}),a.html("");for(var c=0;4>c;c++)$("#diff-items").append(c>b.length-1?'<dl class="item-empty"><dt>'+(c+1)+"</dt><dd>\u60a8\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u6dfb\u52a0</dd></dl>":b[c]);return this.bindEvent("delHover"),this},delContrastItem:function(a,b){if(b){$("#diff-items").html("");for(var c=1;5>c;c++)$("#diff-items").append('<dl class="item-empty"><dt>'+c+"</dt><dd>\u60a8\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u6dfb\u52a0</dd></dl>");this.btnStyle(null,"del"),$("#goto-contrast").removeClass("compare-active"),$(".btn-compare").removeClass("btn-compare-s-active"),$("#goto-contrast").unbind("click"),createCookie(this.cookieName,"",-1,"/;domain="+this.domain)}else $("#cmp_item_"+a).replaceWith('<dl class="item-empty"><dt>'+(parseInt($("#cmp_item_"+a).attr("fore"),10)+1)+"</dt><dd>\u60a8\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u6dfb\u52a0</dd></dl>"),this.sortList().delCookie(a).btnStyle(a,"del"),this.setContrastBtn("reduce");return this},delCookie:function(a){if(this.hasCookie(a)&&null!==a){var b=readCookie(this.cookieName);var c=b.replace(new RegExp(a+".|."+a+"|"+a),"");createCookie(this.cookieName,c,0,"/;domain="+this.domain)}return this},setCookie:function(a){var b=readCookie(this.cookieName)||"";return skuArr=b.split("."),!this.hasCookie(a)&&skuArr.length<4&&(b?(skuArr.push(a),createCookie(this.cookieName,skuArr.join("."),1,"/;domain="+this.domain)):createCookie(this.cookieName,a,1,"/;domain="+this.domain)),this},hasCookie:function(a){return a?new RegExp(a).test(readCookie(this.cookieName)):void 0},setRecentScroll:function(){var a=this;$(".tab-scroll").switchable({type:"carousel",hasPage:!0,prevClass:"sb-prev",nextClass:"sb-next",autoPlay:!1,visible:4,step:4}),a.bindEvent("cmpBtn")},getRecent:function(a){var b=this;var c=readCookie("ipLoc-djd");$.ajax({url:"//diviner.jd.com/diviner",data:{p:202001,lid:c?c.split("-")[0]:1,ck:"pin,aview",lim:23,ec:this.recentCharset},dataType:"jsonp",success:function(c){$("#scroll-con-inner p").length>0&&$("#scroll-con-inner p").remove(),pageConfig._contrast=[],$("#scroll-con-inner").append(b.TPL.recentItem.process(c));var d=readCookie(b.cookieName);if(d){var e=d.split(".");var f=e.length;for(var g=0;f>g;g++)$("#rec_item_"+e[g]).length>0&&b.btnStyle(e[g],"set")}"function"==typeof a&&a(pageConfig._contrast)}})},setMessage:function(a){$(".pop-compare-tips").text(a).fadeIn(),setTimeout(function(){$(".pop-compare-tips").fadeOut()},8e3)}};b.exports=f});
