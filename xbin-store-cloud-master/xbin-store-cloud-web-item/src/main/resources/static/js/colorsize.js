/*!Name: colorsize.js
 * Date: 2017-2-14 17:14:15 */
define("MOD_ROOT/js/colorsize",function(require,exports,module){function t(t){var a={"&amp;":"&","&lt;":"<","&gt;":">","&apos;":"'","&quot;":'"'},n=t;for(var e in a)a.hasOwnProperty(e)&&(n=n.replace(new RegExp(e,"ig"),a[e]));return n}function a(t,a){if(t.indexOf)return t.indexOf(a)>-1;for(var n=0;n<t.length;n++){var e=t[n];if(a===e)return!0}return!1}function n(t,n){for(var e=[],r={},o=0;o<t.length;o++){for(var s=t[o],i=[],l=0;l<n.length;l++){var u=n[l];r[u]||(r[u]=[]),a(r[u],s[u])||r[u].push(s[u]),i.push(s[u])}e.push({path:i.join(S),sku:s.skuId,stock:s.stock?1:0})}return{result:r,items:e}}function e(t){for(var a=[],n=0;n<t.length;n++)a.push(t[n].path);return a}function r(t){for(var a=[[]],n=0;n<t.length;n++)for(var e=0,r=a.length;r>e;e++)a.push(a[e].concat(t[n]));return a}function o(a){for(var n=e(a),o=0;o<n.length;o++)for(var s=n[o],i=a[o].sku,l=a[o].stock,u=s.split(S),f=r(u),c=0;c<f.length;c++){var d=f[c],v=d.join(S);if(v){var h=t(v);E[h]?(E[h].skus.push(i),E[h].stock+=l):E[h]={skus:[i],stock:l}}}}function s(t,a){var n=new RegExp("^"+a+"+","g"),e=new RegExp(a+"+$","g"),r=new RegExp(a+"+","g");return t.replace(n,"").replace(e,"").replace(r,a)}function i(){var t=[];return D.each(function(){var a=$(this).find("."+A);a.length?t.push(a.attr("data-value").toString()):t.push("")}),t}function l(t){function a(t){return t&&-1!=t&&34!=t&&0!=t}function n(t){for(var n=0;n<b.length;n++){var e=b[n],r=t[e.skuId];e.stock=r?a(r.StockState):!0}}for(var e=[],r=0;r<b.length;r++){var o=b[r];o.skuId&&e.push(o.skuId)}e.length>100&&(e=e.slice(0,100)),$.ajax({url:"//c0.3.cn/stocks",dataType:"jsonp",data:{type:"getstocks",skuIds:e.join(","),area:R.getAreaId().areaIds.join("_")},success:function(a){a&&(n(a),t())}})}function u(t){O();for(var a=0;a<_.length;a++)for(var n=_[a],e=T.result[n],r=t.slice(),o=0;o<e.length;o++){var i=e[o];if(t[a]!=i){r[a]=i;var l=s(r.join(S),S),u=D.filter('[data-type="'+n+'"]').find('[data-value="'+i+'"]');r[a]="\u300c"+i+"\u300d";var f=r.join("-");E[l]?(u.removeClass(P),E[l].stock<1?u.addClass(B).attr("title",f+" \u65e0\u8d27"):u.removeClass(B)):u.addClass(P).attr("title",f+" \u65e0\u6b64\u5546\u54c1")}}}function f(t){t.siblings().removeClass(A),t.addClass(A)}function c(t){var a=t.parents("[data-type]").eq(0),n=a.data("idx"),e=a.data("type"),r=t.attr("data-value");t.removeClass(P),q[n]=r,D.not(a).find("[data-value]").removeClass(A),u(i());for(var o=0;o<_.length;o++){var s=_[o],l=z.find('[data-type="'+s+'"]');if(s!=e){var f=l.find('[data-value="'+q[o]+'"]');f.hasClass(P)||(f.addClass(A),u(i()))}}}function d(){for(var t=0;t<_.length;t++){var a=_[t],n=z.find('[data-type="'+a+'"]');n.find("."+A).length<1?n.addClass(F):n.removeClass(F)}}function v(t){for(var a=0;a<b.length;a++){for(var n=b[a],e=!0,r=0;r<_.length;r++){var o=_[r];if(n[o]!==t[r]){e=!1;break}}if(e)return n.skuId}return!1}function h(){function t(t){var a=t.hasClass(P);a?c(t):q[t.parents("[data-type]").eq(0).data("idx")]=t.val(),u(i()),d(),m()}function a(){var t=z.find("."+A).length;if(t>=_.length){var a=i(),n=v(a);n?p(n):k("["+a.join(" - ")+"] \u4e0d\u5b58\u5728\uff0c\u8bf7\u9009\u62e9\u5176\u5b83\u642d\u914d")}}function n(n){var e=n.hasClass("."+A);e||(f(n),H?a(n):t(n))}z.undelegate().delegate("[data-value]","click",function(){n($(this))})}function g(){z.find("[data-value]").each(function(){var t=$(this).attr("data-value");E[t]||$(this).hasClass(A)||$(this).addClass(P)})}function p(t){location.href="//item.jd.com/"+t+".html"+location.search}function k(t){M.show().find(".dd").html(t)}function m(){for(var t=i(),a=[],n=0;n<t.length;n++){var e=t[n];e&&a.push(e)}if(a.length&&a.length==_.length){var r=E[a.join(S)];J?k(a.join(" - ")):r&&w.skuid!=r.skus[0]&&p(r.skus[0])}}function C(){D.each(function(){var t=$(this).data("type");t&&_.push(t)}),_.length>G&&(H=!0)}function j(t){var a=t.attr("data-value");a&&t.attr("title",a)}function O(){z.find(".item").each(function(){j($(this))})}function y(){E={},_=[],q=[],T={},z.find("[data-value]").removeClass(P).removeClass(B),D.removeClass(F)}function x(){return b?(y(),C(),h(),void(H||(q=i(),l(function(){T=n(b,_),o(T.items),g(),u(i()),J&&m(),/debug=res/.test(location.href)&&(console.log(E),console.log(q))})))):!1}function I(){return z.length?void x():!1}var R=require("MOD_ROOT/js/tools"),w=(require("MOD_ROOT/js/event").Event,pageConfig.product),b=w.colorSize,E={},S="\u2299",T={},_=[],q=[],z=$("#choose-attrs"),D=z.find("[data-type]"),M=$("#choose-results"),A="selected",P="disabled",B="no-stock",F="item-hl-bg",G=6,H=!1,J=!1;/lessAttr/.test(location.href)&&(G=2),/selected/.test(location.href)&&(J=!0),exports.init=I});