/*!Name: bigouma.js
 * Date: 2017-2-14 17:14:15 */
define("MOD_ROOT/js/bigouma",function(require,exports,module){var t=require("JDF_UNIT/js/login"),n=require("MOD_ROOT/js/core"),i=require("MOD_ROOT/js/event").Event,s={init:function(t){return this.sku=t.skuid,this.cfg=t,this.$cd=$("#choose-countdown"),this.$cdTxt=this.$cd.find("#bgm-countdown"),this.$txt=$(".J-bgm-text"),this.$btn=$("#choose-btn-bgm"),this.$btnWrap=$("#choose-btns"),this.BTN_DISABLE="btn-disable",this.$btn.length&&(this.onBGM(),this.get(),this.bindEvent()),this},bindLogin:function(){var t=this;this.$btnWrap.delegate(".J-s-login","click",function(){return t.loginIframe(),!1})},bindEvent:function(){function t(t,n){var i=t.attr("href")||"";return i.replace(/pcount=\d+/,"pcount="+n)}var n=this;i.addListener("onNumChange",function(i){var s=n.$txt.find(".J-bind");s.attr("href",t(s,i.count)),n.bgmEnabled&&n.enabled()}),i.addListener("onStockReady",function(t){pageConfig.product.havestock?n.bgmEnabled&&n.enabled():n.disabled()})},loginIframe:function(){t({modal:!0,complete:function(){window.location.reload(!0)}})},onBGM:function(){this.$btn.show(),this.cfg.addToCartBtn.hide(),this.cfg.oneKeyBuyBtn.hide()},get:function(){var t=this;$.ajax({url:"//jcode.jd.com/jcodeinfo.action",data:{sku:this.sku},dataType:"jsonp",success:function(n){t.set(n)}})},enabled:function(t){return this.bgmEnabled=!0,this.cfg.isClosePCShow||!this.cfg.havestock?!1:(this.$btn.removeClass(this.BTN_DISABLE),this.$btn.attr("href",t||this.cfg.addToCartBtn.href),void this.$txt.addClass("bgm-text-active"))},disabled:function(){this.$btn.attr("href","#none"),this.$btn.addClass(this.BTN_DISABLE)},set:function(t){var n=t.cs&&1===t.cs,i=t.d&&t.d>0;if(this.isLogin=t&&t.lg&&1===t.lg,2===t.jtype)return this.enabled(),this.setBtnText("\u52a0\u5165\u8d2d\u7269\u8f66"),!1;if(this.isLogin&&this.$btnWrap.undelegate("click"),n){if(2===t.status&&i&&this.setCountdown(t.d),!t.lg)return this.setLoginTips(),this.bindLogin(),!1;if(!t.b)return this.setBindTips(t.url);this.enabled()}else this.setSupportText(t&&t.source)},setBtnText:function(t){this.$btn.text(t||"\u5fc5\u8d2d\u7801\u8d2d\u4e70")},setSupportText:function(t){t=t.substr(1);var n=["\u4eac\u4e1capp","\u5fae\u4fe1","\u624b\u673aQQ"],i=[];if(t)for(var s=t.split(""),e=0;e<s.length;e++)"1"===s[e]&&i.push(n[e]);i.length>0?this.$txt.html("\u8bf7\u5230"+i.join("\u3001")+"\u8d2d\u4e70"):this.$txt.html("")},setLoginTips:function(){this.$txt.html('\u8bf7 <span href="#none" class="hl_blue J-s-login" style="cursor:pointer">\u767b\u5f55</span> \u540e\u786e\u8ba4\u8d2d\u4e70\u8d44\u683c')},setBindTips:function(t){t.indexOf("pcount")<0&&(t+="&pcount=1");var n='            \u8bf7\u5148 <a href="'+t+'" class="hl_blue J-s-login J-bind" style="display:inline;" target="_blank">\u7ed1\u5b9a/\u9886\u53d6\u5fc5\u8d2d\u7801 </a>\u518d\u8d2d\u4e70\u3002';this.$txt.html(n)},setCountdown:function(t){function i(t,n){return t.replace(/{d}/g,n.d).replace(/{h}/g,n.h).replace(/{m}/g,n.m).replace(/{s}/g,n.s)}var s=this;this.$cd.show(),n.Countdown.init(t,function(t){s.$cdTxt.html(i("{d}\u5929{h}\u5c0f\u65f6{m}\u5206{s}\u79d2",t))})}};module.exports=s,module.exports.__id="bgm"});