/*!Name: address.js
 * Date: 2017-2-14 17:14:14 */
define("MOD_ROOT/js/address",function(require,exports,module){function e(e,t){this.$el=e,this.cfg=t,this.$el.length&&this.init()}function t(e){function a(a,s){e.hasLevel4(a)&&0===s[3]&&e.getNextArea(s[2],function(a){a&&a.length&&(s[3]=a[0].id,e.setCookie(s),t())})}new d({},function(t){h.fire({type:"onStockReady",area:{id:this.areas},stock:t}),h.fire({type:"onDefaultStockReady",area:{id:this.areas},stock:t}),e&&(a(t.stock,this.areas),e.validateCookie(t.stock))})}function a(e,a){t(a),h.addListener("onNumChange",function(){t(a)})}function s(){var e=c.getAreaId().areaIds,t=pageConfig.FN_getDomain();if(3==e.length){e.push(0);var a=e.join("-");createCookie("ipLoc-djd",a,30,"/;domain="+t)}}function i(e){function t(t){var a=e.jp||"",s=t.stock.stock,i={webstate:1,delivestate:5,stock:33},r=2==s.code?-1:s.StockState,n={33:1,34:4,0:4,39:2,40:2,36:3},o={"-1":6};n[r]&&(i.webstate=n[r]),o[r]&&(i.delivestate=o[r]),i.stock=r;var d={area:t.area.id.join("_"),sku:[[e.skuid,a,i.webstate,i.delivestate,i.stock]]};"function"==typeof logJSON&&logJSON("pv_stock","sku",d)}h.addListener("onStockReady",function(e){setTimeout(function(){t(e)},500)})}function r(e){var t=$("#summary-weight");h.addListener("onStockReady",function(e){var a=e.stock.stock;a.weightValue?t.show().find(".dd").text(a.weightValue):t.hide().find(".dd").text("")})}function n(t){s(),i(t);var n=new e($("#stock-address"),t);a(t,n),r(t)}var o=require("MOD_ROOT/js/area"),d=require("MOD_ROOT/js/stock"),h=require("MOD_ROOT/js/event").Event,c=require("MOD_ROOT/js/tools");require("MOD_ROOT/js/EDropdown"),require("MOD_ROOT/js/ETab"),e.prototype={init:function(){this.VAL_KEY="data-value",this.RES_ATTR="data-res",this.AREA_CLICKED="clicked",this.$tabItems=null,this.$tabTrigs=null,this.$areaTab=this.$el.find(".J-address-tab"),this.$commArea=this.$el.find(".J-common-address"),this.$stockAddressInner=this.$el.find(".inner"),this.$stockAddressArr=this.$el.find(".head .arrow"),this.$stockAddressUsed=this.$el.find(".address-used"),this.$stockAddressSelect=this.$el.find(".address-select"),this.level=0,this.MAX_LEVEL=3,this.area={id:[1,72,2799,0],uid:null,name:["\u5317\u4eac","","",""]},this.checkCookie(),this.bindEvent(),this.setProvince(),this.areaId=c.getAreaId(),this.area.uid=this.areaId.commonAreaId},onOpen:function(){var e=this;this.$stockAddressInner.addClass("border"),this.$stockAddressArr.addClass("arr-open"),this.hasSetSelectedAddress||(this.getCommonAddress(),this.setSelectedAddress(function(){var t=[e.area.id[0],e.area.id[1],e.area.id[2],0];new d({area:t.join("_")},function(t){e.hasLevel4(t.stock)&&e.loadLevel4Areas()},null,!0)}),this.hasSetSelectedAddress=!0)},loadLevel4Areas:function(){var e=this.areaId.areaIds;4===e.length&&(this.level=2,this.getNextArea(e[this.level],$.proxy(this.setLevel4Name,this)))},setLevel4Name:function(e){if(!e||!e.length)return!1;var t=null,a=c.getAreaId().areaIds[3];if(0===a)t=e[0];else for(var s=0;s<e.length;s++)if(e[s].id===a){t=e[s];break}this.$tabTrigs.eq(3).html(t.name),this.updateSelected(t.id,t.name,3)},onClose:function(){this.$el.removeClass("hover"),this.$stockAddressInner.removeClass("border"),this.$stockAddressArr.removeClass("arr-open"),this.$el.removeAttr("data-disable")},bindEvent:function(){var e=this;this.$el.undelegate("click.disable_close").delegate('[data-drop="head"],[data-drop="content"]',"click.disable_close",function(){e.$el.attr("data-disable",!0)}),$(document).unbind("click.address").bind("click.address",function(t){$(t.target).parents("#stock-address").length<1&&($.browser.isIE7()||e.onClose())}),this.$areaTab.ETab({onSwitch:function(t){e.onSwitch(t)}}),pageConfig.ADDRESS_TAB=this.$areaTab.data("ETab"),this.$tabItems=this.$areaTab.data("ETab").items,this.$tabTrigs=this.$areaTab.data("ETab").triggers,this.$el.EDropdown({onOpen:function(){e.onOpen()},onClose:function(){e.onClose()}}),this.$dropdown=this.$el.data("EDropdown"),this.$stockAddressUsed.EDropdown({event:"click",current:"clicked"}),this.$stockAddressSelect.data("open",!0).EDropdown({event:"click",current:"clicked"});var t="["+this.VAL_KEY+"]";this.$tabItems.delegate(t,"click.area",$.proxy(this.handleAreaClick,this)),this.$commArea.delegate(t,"click.area",$.proxy(this.handleCommonAddressClick,this))},renderItem:function(e){for(var t="",a=null,s=0;s<e.length;s++)a=e[s],a.name.length>6&&e.push(e.splice(s,1)[0]);for(var s=0;s<e.length;s++)a=e[s],a.name.length>12&&e.push(e.splice(s,1)[0]);for(var s=0,i=e.length;i>s;s++){a=e[s];var r="";a.name.length>6&&(r="long-area"),a.name.length>12&&(r="longer-area"),t+='<li data-name="'+a.name+'" data-value="'+a.id+'" class="'+r+'"><a href="#none">'+a.name+"</a></li>"}return t},setProvince:function(){this.$tabItems.eq(0).html(o.provinceHtml)},validateCookie:function(e){var t=e.area;!t||""!==t.provinceName&&""!==t.cityName&&""!==t.countyName||this.checkCookie()},hasCityId:function(e,t){for(var a=o.data[0][e],s=a.length,i=0;s>i;i++){var r=a[i];if(r.id==t)return!0}return!1},hasCountyId:function(e,t){for(var a=e.length,s=0;a>s;s++){var i=e[s];if(i.id==t)return!0}return!1},checkCookie:function(){var e=this,a=c.getAreaId(),s=a.areaIds,i=a.commonAreaId,r=s[0],n=s[1],d=s[2];if(isNaN(r)||!o.provinceMap[r])return this.setCookie(this.area.id,o.provinceMap[r],i),t(e),!1;var h=!1;this.hasCityId(r,n)||(n=o.data[0][r][0].id,h=!0),this.getNextArea(n,function(a){e.hasCountyId(a,d)||(d=a[0].id,h=!0),h&&(e.setCookie([r,n,d,0],o.provinceMap[r],i),e.areaId=c.getAreaId(),t(e))})},handleAreaClick:function(e){var t=$(e.target).parent(),a=t.data("value"),s=t.text(),i=t.parents('[data-tab="item"]').eq(0).data("level");this.area.uid=null,this.setArea(a,i,s)},setPreviousAreasData:function(e){for(var t=0;e>t;t++){var a=this.$tabTrigs.eq(t);this.setAreaData(a.attr("data-id"),a.text(),t)}},setArea:function(e,t,a){this.level=Number(t),this.reset(this.level),this.setPreviousAreasData(t),this.setAreaData(e,a,t),this.updateSelected(e,a,t),this.level===this.MAX_LEVEL?this.getStock($.proxy(this.setResultAddress,this)):this.level===this.MAX_LEVEL-1?this.checkLevel4(e):this.getNextArea(e)},getNextArea:function(e,t){var a=this;t=t||function(){},this.getNextAreaData(e,function(s){a.onSuccess(s,e),t(s)},function(){1===a.level&&(console.log("address server error."),a.setAreaData(o.area[e],"\u8bf7\u9009\u62e9",++a.level),a.setResultAddress())})},hasLevel4:function(e){return e&&4===e.level&&3===e.code},checkLevel4:function(e){var t=this;this.__stock=new d({area:this.area.id.join("_")},function(a){t.hasLevel4(a.stock)?t.getNextArea(e):(t.__stock.set(a),t.setResultAddress(),t.triggerStockEvent(a))},null,!0)},onSuccess:function(e,t){var a=this.renderItem(e);o.data[this.level][t]=e,this.$tabTrigs.eq(this.level+1).trigger("click.ETab").show(),this.$tabItems.eq(this.level+1).html(a),this.level>=this.MAX_LEVEL&&this.setResultAddress()},setCookie:function(e,t,a){function s(e){return e.replace(/^-+|-+$/g,"")}e=e||this.area.id,t=t||this.area.name[0],a=a||this.area.uid;var i=pageConfig.FN_getDomain(),r=s(e.join("-"));this.area.uid&&(r+="."+a),createCookie("ipLocation",escape(t),30,"/;domain="+i),createCookie("areaId",e[0],10,"/;domain="+i),createCookie("ipLoc-djd",r,30,"/;domain="+i)},getNextAreaData:function(e,t,a){return a=a||function(){},o.data[this.level][e]?t(o.data[this.level][e]):void $.ajax({url:"//d.jd.com/area/get",data:{fid:e},timeout:1e3,dataType:"jsonp",cache:!0,jsonpCallback:"getAreaListCallback",success:$.proxy(t,this),error:$.proxy(a,this)})},truncateTabName:function(e){return e.length>5?e.substr(0,5):e},updateSelected:function(e,t,a){var s=this.AREA_CLICKED;this.setTabName(a,e,t),this.$tabItems.eq(a).find("a").removeClass(s).filter("["+this.VAL_KEY+"="+e+"]").addClass(s)},setTabName:function(e,t,a){var s=this.truncateTabName(a),i={};t&&(i["data-id"]=t),a.length>5&&(i.title=a),this.$tabTrigs.eq(e).text(s).attr(i)},setResultAddress:function(e){e=e||this.area.name.join(" "),this.$el.find("["+this.RES_ATTR+"]").text(e),this.close()},setAreaData:function(e,t,a){this.area.id[a]=Number(e),this.area.name[a]=t},handleCommonAddressClick:function(e){for(var t=$(e.target).parent(),a=t.data("value").split("|"),s=a[0],i=s.split(".")[0],r=s.split(".")[1],n=i.split(","),d=a[1],h=0;h<n.length;h++)n[h]=Number(n[h]);this.area.id=n,this.area.uid=Number(r),this.area.name[0]=o.provinceMap[n[0]],this.setResultAddress(d),this.setCookie(),this.getStock($.proxy(this.close,this))},getCommonAddress:function(){var e=this;$.ajax({url:"//cd.jd.com/usual/address",dataType:"jsonp",scriptCharset:"gbk",success:function(t){t&&t.length&&e.setCommonAddress(t)}})},setSelectedAddress:function(e){var t=pageConfig._CURR_AREA,a=this.$tabItems.eq(0).find('[data-name="'+t.provinceName+'"]'),s=a.data("value"),i=o.data[0][s],r=this.renderItem(i);this.$tabItems.eq(1).html(r),this.setTabName(0,s,t.provinceName),this.setTabName(1,this.areaId.areaIds[1],t.cityName),this.setTabName(2,this.areaId.areaIds[2],t.countyName),this.setTabName(3,this.areaId.areaIds[3],""),this.area.id=this.areaId.areaIds,this.level=1,this.getNextArea(this.areaId.areaIds[this.level],e)},setCommonAddress:function(e){function t(e){return e.addressName=e.addressName.replace("null","").substring(0,8),e.addressDefault&&(e.addressName="\uff08\u9ed8\u8ba4\uff09"+e.addressName),'<li {0}="{1},{2},{3},{4}.{5}|{6}"><a title="{7}" href="#none">{8}</a></li>'.format(s,e.provinceId,e.cityId,e.countyId,e.townId,e.id,e.areaName,e.fullAddress,e.addressName)}var a="",s=this.VAL_KEY,i=!1;a+="<ul>";for(var r=0;r<e.length&&5>r;r++){var n=e[r];n.addressName&&(a+=t(n),i=!0)}a+="</ul>",i?this.$stockAddressUsed.addClass("clicked").data("open",!0).show():this.$stockAddressUsed.hide(),this.$commArea.html(a)},reset:function(e){0==e&&(this.resetItem(1),this.resetItem(2),this.resetItem(3)),1==e&&(this.resetItem(2),this.resetItem(3)),2==e&&this.resetItem(3)},resetItem:function(e){this.area.id[e]=0,this.area.name[e]="",this.$tabTrigs.eq(e).text("\u8bf7\u9009\u62e9"),this.$tabTrigs.eq(e+1).length&&this.$tabTrigs.eq(e+1).hide()},close:function(){this.$dropdown.close(),this.setCookie()},onSwitch:function(e){this.level=e},triggerStockEvent:function(e){h.fire({type:"onStockReady",area:this.area,stock:e}),h.fire({type:"onAreaChange",area:this.area,stock:e})},getStock:function(e){var t=this;new d({area:this.area.id.join("_")},function(a){e.call(t,a),t.triggerStockEvent(a)})}},module.exports.__id="address",module.exports.init=n});
