/*!Name: gift.js
 * Date: 2017-2-14 17:14:16 */
define("MOD_ROOT/js/gift",function(require,exports,module){var t=require("MOD_ROOT/js/buybtn").addToCartBtn,e=require("MOD_ROOT/js/event").Event,i=require("MOD_ROOT/js/core");require("MOD_ROOT/css/gift.css");var o={skus:[],init:function(t){return this.$el=$("#choose-gift"),this.$gift=this.$el.find(".J-gift"),this.$count=this.$gift.find("em"),this.$selected=this.$el.find(".J-gift-selected"),this.$el.length&&t&&t.giftPool&&t.giftPool.length?(pageConfig.haveGift=!0,this.hasSelected=!1,this.data=t,this.bindEvent(),this.$count.html(t.giftPool.length),void this.$el.show()):(this.$el.hide(),!1)},bindEvent:function(){var e=this,i=$(document);this.$el.undelegate("click"),this.$el.delegate(".J-gift,.J-popup,.J-gift-choosed","click.popup",function(){e.showGiftSelect()}),i.undelegate("click.gift_pool_item"),i.delegate(".J-choose-gift-layer .J-select","click.gift_pool_item",function(){e.select($(this))}),i.delegate(".J-choose-gift-layer .J-select","mouseover",function(){e.hover($(this))}),i.delegate(".J-gift-pool","mouseleave",function(){e.leave($(this))}),i.delegate(".J-gift-pool-ok","click",function(){e.collectSelectedSkus()});var o=pageConfig.product,n=t.$el.add(o.oneKeyBuyBtn.$el).add($("#btn-baitiao"));n.unbind("click.validate_gift"),n.bind("click.validate_gift",function(){return pageConfig.giftSelected?void 0:(e.$el.addClass("item-hl-bg"),!1)})},showGiftSelect:function(){var t=this;pageConfig.getGiftPoolDataStr=function(t){return t.sid+"|"+t.num+"|"+encodeURIComponent(t.mp)+"|"+encodeURIComponent(t.nm)},pageConfig.getGiftPoolStatus=function(e,i){var o="-"+e.sid+"-",n="-"+t.skus.join("-")+"-";return n.indexOf(o)>-1?"choosed":0!=i||t.hasSelected?"":"choosed"};var e='            <div class="J-choose-gift-layer choose-gift-layer">                {for pool in giftPool}                <div class="J-gift-pool gift-pool" data-res="">                <dl class="J-gift-list gift-list">                    <dt>${pool.poolName}</dt>                    {for item in pool.list}                    <dd>                        <a href="#none" class="J-select p-img ${pageConfig.getGiftPoolStatus(item, item_index)}"                             data-res="${pageConfig.getGiftPoolDataStr(item)}" >                            <img src="${pageConfig.FN_GetImageDomain(item.sid)}n1/s60x60_${item.mp}" alt="${item.nm}"/>                        </a>                    </dd>                    {/for}                </dl>                <p class="p-name">${pool.list[0].nm}</p>                </div>                {/for}                <div class="bt-wrap">                    <a href="#none" class="J-gift-pool-ok btn-confirm">\u786e\u5b9a</a>                    <a href="#none" onclick="$.closeDialog();" class="J-gift-pool-cancel btn-cancel"                         clstag="shangpin|keycount|product|zengpintanceng-guanbi">\u53d6\u6d88</a>                </div>            </div>',i=e.process(this.data);require.async("JDF_UI/js/dialog",function(){$("body").dialog({type:"html",mainId:"gift-pool-popup",width:530,title:"\u9009\u62e9\u8d60\u54c1",source:i,onReady:function(){t.$giftLayer=$(".J-choose-gift-layer"),t.$giftLayer.find(".choosed").trigger("click.gift_pool_item"),$("#gift-pool-popup .ui-dialog-close").attr("clstag","shangpin|keycount|product|zengpintanceng-guanbi")}})})},collectSelectedSkus:function(){var t={data:[]},i=[];this.$giftLayer.find(".J-gift-pool").each(function(){var e=$(this).attr("data-res").split("|"),o=e[0],n=e[1],s=decodeURIComponent(e[2]),a=decodeURIComponent(e[3]);t.data.push({sku:o,num:n,img:s,name:a}),o&&i.push(o)}),pageConfig.giftSelectedSkuids=i,pageConfig.giftSelected=!0,this.skus=i,this.hasSelected=this.skus.length>0,e.fire({type:"onGiftSelected",skus:i}),this.hasSelected&&this.$el.removeClass("item-hl-bg"),this.updateSelected(t),this.setBtnLink(),$.closeDialog()},updateSelected:function(t){var e='            {for item in data}                <img src="${pageConfig.FN_GetImageDomain(item.sku)}n1/s40x40_${item.img}" />                <span>x ${item.num}</span>            {/for}';this.$gift.hide(),this.$selected.show(),this.$selected.find(".J-gift-choosed").html(e.process(t))},setBtnLink:function(){var e=t.$el.attr("href");t.enabled(i.getHrefWithGift(e,this.skus))},setName:function(t,e){var i=e.split("|"),o=i[0],n=decodeURIComponent(i[3]),s=null,a='<a href="//item.jd.com/{0}.html" target="_blank" title="{1}">{2}</a>',l="<span>\u3000x{0}</span>";n.length>29&&(s=n.substr(0,29)+"..."),t.html(a.format(o,n,s||n)+l.format(i[1]))},leave:function(t){var e=t.find(".p-name");this.setName(e,t.find(".choosed").attr("data-res"))},hover:function(t){var e=t.parents(".J-gift-pool").eq(0),i=e.find(".p-name"),o=t.attr("data-res");this.setName(i,o)},select:function(t){var e=t.parents(".J-gift-pool").eq(0),i=e.find(".J-select"),o=e.find(".p-name"),n=t.attr("data-res");i.removeClass("choosed"),t.addClass("choosed"),e.attr("data-res",n),this.setName(o,n)}};module.exports=o});