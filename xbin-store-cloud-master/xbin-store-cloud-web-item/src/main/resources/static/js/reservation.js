/*!Name: reservation.js
 * Date: 2017-2-14 17:14:15 */
define("MOD_ROOT/js/reservation",function(require,exports,module){function t(t){function e(){$("body").dialog({title:n,type:"iframe",source:o,width:600,height:200})}var i=t.isPinGou?"1":"3",n=t.isPinGou?"\u9080\u8bf7\u597d\u53cb":"\u5206\u4eab",o="//fenxiang.jd.com/shareFront/initShareIcons.action?sku="+t.skuid+"&flag="+i;s({modal:!0,complete:function(t){t&&t.Identity&&t.Identity.IsAuthenticated&&e()}})}var e=require("MOD_ROOT/js/tools").Countdown,i=require("MOD_ROOT/js/event").Event,n=require("MOD_ROOT/js/tools"),s=require("JDF_UNIT/js/login"),o=require("MOD_ROOT/js/core");require("JDF_UI/js/dialog");var a={init:function(t){this.$el=$("#btn-reservation,#btn-reservation-mini"),this.$banner=$("#yuyue-banner"),this.$process=$("#yuyue-process"),this.jnbtBtn=t.jnbtBtn,this.cfg=t,this.cfg.isYuYue&&(this.$count=this.$banner.find(".J-count"),this.$time=this.$banner.find(".J-time"),this.bindEvent(),this.get())},invite:function(){return t(this.cfg)},bindEvent:function(){var t=this;$(document).delegate(".J-yuyue-share","click.pingou_invite",function(){t.invite()}),$(".J-yuyue-tips .J-tips").unbind("click").bind("click",function(){$("#detail").length&&$("html,body").scrollTop($("#detail").offset().top),$("#pingou-rules-tab").trigger("click")}),i.addListener("onStockReady",function(e){var i=t.cfg.jnbtBtn,n=e.area.id[0];t.cfg.havestock?i.enabled():i.disabled(),"1"==n&&t.ysSupportJnbt?i.show():i.hide(),4===t.state&&(t.cfg.havestock?t.enabled():t.disabled())}),i.addListener("onLDPSelected",function(e){t.LDP=e.did,t.enabled()})},get:function(){var t=this;$.ajax({url:"//yushou.jd.com/youshouinfo.action",data:{sku:this.cfg.skuid},dataType:"jsonp",timeout:6e3,error:function(){t.onError()},success:function(e){e&&"1"===e.type?t.set(e):t.onError()}})},log:function(t){o.log(null,"reservation.js",t)},onError:function(){this.cfg.addToCartBtn.reInit(this.$el.eq(0)),this.log("YuShou service return a error, Maybe the YuShou special attr has expired or service unavailable.")},set:function(t){this.$el.show(),this.setCountdown(t),this.setCategory(t.category),this.setProcess(t),this.checkState(t),this.supportJNBT(t)},setCategory:function(t){var e=$(".J-yy-category"),i=null;"1"===t&&(i="\u9884\u7ea6\u4eab\u8d44\u683c"),"3"===t&&(i="\u9884\u7ea6\u4eab\u4f18\u60e0"),i?e.html(i).show():e.hide()},setProcess:function(t){function e(t){return t?t.replace(/:\d\d$/,""):""}var i=this.$process.find(".J-step2"),n=this.$process.find(".J-step4");i.html(e(t.yueStime)+"-"+e(t.yueEtime)),n.html(e(t.qiangStime)+"-"+e(t.qiangEtime))},disabled:function(){this.$el.addClass("btn-disable"),this.$el.attr("href","#none"),this.isEnabled=!0},enabled:function(){return this.cfg.isClosePCShow?!1:(this.url&&(this.url=n.addUrlParam(this.url,"did",this.LDP),this.$el.attr("href",this.url)),this.$el.removeClass("btn-disable"),void(this.isEnabled=!0))},setCountdown:function(t){var i=this.$time,n=this.$banner.find(".J-text"),s="\u5269\u4f59";this.$count.html(t.num),1===t.state&&(s="\u8ddd\u9884\u7ea6\u8fd8\u9700"),2===t.state&&(s="\u9884\u7ea6\u5269\u4f59"),3===t.state&&(s="\u8ddd\u62a2\u8d2d\u8fd8\u9700"),4===t.state&&(s="\u62a2\u8d2d\u5269\u4f59"),n.html(s),t.d>0?(this.$banner.find(".J-item-2").show(),new e(t.d,function(t){t.d<1?i.html(t.h+"\u5c0f\u65f6"+t.m+"\u5206"+t.s+"\u79d2"):i.html(t.d+"\u5929"+t.h+"\u5c0f\u65f6"+t.m+"\u5206"+t.s+"\u79d2")})):this.$banner.find(".J-item-2").hide()},checkState:function(t){this.state=t.state,this.url=t.url,1===t.state&&(this.$count.hide(),this.setBtnText("\u7b49\u5f85\u9884\u7ea6"),this.disabled()),2===t.state&&(this.setBtnText("\u7acb\u5373\u9884\u7ea6"),this.enabled()),3===t.state&&(this.setBtnText("\u7b49\u5f85\u62a2\u8d2d"),this.disabled()),4===t.state&&(this.setBtnText("\u7acb\u5373\u62a2\u8d2d"),this.cfg.havestock?this.enabled():this.disabled(t.url)),5===t.state&&(this.setBtnText("\u62a2\u8d2d\u5df2\u7ed3\u675f"),this.disabled())},setBtnText:function(t){this.$el.html(t),this.$el.each(function(){var e=$(this).attr("clstag");$(this).attr("clstag",e.replace(/-[\u4e00-\u9fa5]*-/,"-"+t+"-"))})},supportJNBT:function(t){this.ysSupportJnbt=pageConfig.product.ysSupportJnbt=1===t.supportOther,this.ysSupportJnbt?(this.jnbtBtn.show(),this.jnbtBtn.enabled()):this.jnbtBtn.hide()}};module.exports=a,module.exports.showInvite=t,module.exports.__id="Reservation"});