/*!Name: buybtn.js
 * Date: 2017-2-14 17:14:15 */
define("MOD_ROOT/js/buybtn",function(require,exports,module){function t(t){t.addToCartBtn=u.init(t),t.oneKeyBuyBtn=s.init(t),t.notifyBtn=r.init(t),t.bgmBtn=d.init(t),t.jnbtBtn=c.init(t),t.reservationBtn=n.init(t),t.koBtn=a.init(t),l(t),o()}var i=require("MOD_ROOT/js/event").Event,e=require("MOD_ROOT/js/tools"),s=require("MOD_ROOT/js/onekey"),n=require("MOD_ROOT/js/reservation"),a=require("MOD_ROOT/js/ko"),d=require("MOD_ROOT/js/bigouma"),h=require("JDF_UNIT/js/notif");window.setAmount={init:function(){this.min=1,this.max=199,this.count=1,this.disableAdd=!1,this.disableReduce=!0,this.$buyNum=$("#buy-num"),this.$buyBtn=$("#InitCartUrl"),this.$add=$("#choose-btns .btn-add"),this.$reduce=$("#choose-btns .btn-reduce"),this.matchCountKey=["pcount","pCount","num","buyNum"],/debug=num/.test(location.href)&&this.$buyNum.attr("data-min","5");var t=this.$buyNum.data("min");t&&(this.min=t,this.count=t),this.checkLimit(),this.bindEvent()},bindEvent:function(){function t(t,e){t.ETooltips({close:!1,content:'<div class="min-buy-tips"></div>',width:150,position:"bottom",zIndex:10,onOpen:function(){var t='<img src="//img20.360buyimg.com/da/jfs/t2734/145/4239060100/1006/b6d0f0d8/57b4240fN9cc48b02.png" />';this.$tooltips.find(".min-buy-tips").html(e.format(t,i.$buyNum.val()))}})}var i=this;this.$buyNum.unbind("change keydown keyup").bind("change keydown keyup",e.throttle($.proxy(this.handleChange,this),500)),t(this.$reduce,"{0} \u6700\u5c11\u8d2d\u4e70 {1} \u4ef6"),t(this.$add,"{0} \u6700\u591a\u8d2d\u4e70 {1} \u4ef6")},disabledReduce:function(t){this.disableReduce=!0,this.disableAdd=!1,this.$reduce.addClass("disabled"),this.$add.removeClass("disabled"),this.$add.attr("data-disabled","1"),t?this.$reduce.removeAttr("data-disabled"):this.$reduce.attr("data-disabled","1")},disabledAdd:function(t){this.disableAdd=!0,this.disableReduce=!1,this.$add.addClass("disabled"),this.$reduce.removeClass("disabled"),this.$reduce.attr("data-disabled","1"),t?this.$add.removeAttr("data-disabled"):this.$add.attr("data-disabled","1")},enabledAll:function(){this.disableAdd=!1,this.disableReduce=!1,this.$reduce.removeClass("disabled").attr("data-disabled","1"),this.$add.removeClass("disabled").attr("data-disabled","1")},getVal:function(){return this.$buyNum.val()},setVal:function(t){this.$buyNum.val(t)},checkLimit:function(){var t=this.$buyNum.data("min"),i=Number(this.getVal());1>=i&&this.disabledReduce(),i>=this.max&&this.disabledAdd(!0),i>1&&i<this.max&&this.enabledAll(),t&&i===this.min&&this.disabledReduce(!0)},isEmpty:function(t){return""==$.trim(t)},isFloat:function(t){return Number(t)===t&&t%1!==0},add:function(){var t=Number(this.getVal());return this.disableAdd||this.isEmpty(t)?!1:(t>this.min&&(this.disableReduce=!1),t>=this.max?(this.setDisabled(this.$add),this.disableAdd=!0,!1):(this.disableAdd=!1,this.setEnabled(this.$add),this.count++,this.setVal(this.count),this.checkLimit(),void this.setBuyLink()))},reduce:function(){var t=Number(this.getVal());return this.disableReduce||this.isEmpty(t)?!1:(t<this.max&&(this.disableAdd=!1),t<=this.min?(this.setDisabled(this.$reduce),this.disableReduce=!0,!1):(this.setEnabled(this.$reduce),this.disableReduce=!1,this.count--,this.setVal(this.count),this.checkLimit(),void this.setBuyLink()))},handleChange:function(){var t=this.getVal(),i=null;isNaN(Number(t))||this.isEmpty(t)||this.isFloat(Number(t))?i=this.count:(t<this.min&&(i=this.min,this.disabledReduce(1!==i)),t>this.max&&(i=this.max,this.disabledAdd(!0))),i?(this.count=i,this.$buyNum.val(i)):this.count=Number(t),this.checkLimit(),this.setBuyLink()},modify:function(){},setDisabled:function(t){t.attr("data-disabled",1)},setEnabled:function(t){t.removeAttr("data-disabled")},setBuyLink:function(){var t=this;t.$buyBtn.each(function(){var i,e,s=$(this),n=s.attr("href"),a=n.split("?")[1];!function(){for(var d=0;d<t.matchCountKey.length;d++)if(e=new RegExp(t.matchCountKey[d]+"=\\d+"),e.test(a))return i=n.replace(e,t.matchCountKey[d]+"="+t.count),s.attr("href",i),!1}()}),i.fire({type:"onNumChange",count:this.count})}},setAmount.init();var o=function(){function t(t,i){t.attr("href",t.attr("href").replace(/(nums|pcount)=\d+/g,"$1="+i))}var e=$("#choose-btn-gift");/gift=true/.test(location.href)&&($("#choose-btn-gift").show(),i.addListener("onNumChange",function(i){t(e,i.count)}))},u={init:function(t){return this.cfg=t,this.$el=$("#InitCartUrl,#InitCartUrl-mini"),this.cName="btn-disable",this.originHref=this.$el.attr("href"),this.href=this.$el.attr("href"),this.bindEvent(t),this},reInit:function(t){var i='<a href="'+this.cfg.addToCartUrl+'" id="InitCartUrl" class="btn-special1 btn-lg" clstag="shangpin|keycount|product|\u52a0\u5165\u8d2d\u7269\u8f66_1">\u52a0\u5165\u8d2d\u7269\u8f66</a>';$("#InitCartUrl").length<1&&t.before(i),this.init(this.cfg),this.disabled(),this.enabled()},bindEvent:function(t){function e(){t.havestock?s.enabled():s.disabled()}var s=this;i.addListener("onStockReady",e)},show:function(){var t=this.cfg.isHeYue||this.cfg.isYuShou||this.cfg.isBiGouMa||this.cfg.isKO;return t?!1:void this.$el.show()},hide:function(){this.$el.hide()},updateNum:function(t){var i=$("#buy-num").val();return t?t.replace(/(nums|pcount|buyNum)=\d+/g,"$1="+i):void 0},disabled:function(){var t=this.$el.attr("href");return this.$el.addClass(this.cName),this.$el.attr("href","#none"),t},enabled:function(t){t=this.updateNum(t||this.href);var i=this.cfg.isClosePCShow||!this.cfg.havestock;return i?!1:(this.$el.removeClass(this.cName),this.$el.attr("href",t),void(this.href=t))}},r={init:function(t){return this.cfg=t,this.$el=$("#btn-notify"),h({el:$(".J-notify-sale")}),h({el:$(".J-notify-stock")}),this.bindEvent(),this},show:function(){this.cfg.havestock||this.cfg.unSupportedArea?this.hide():this.$el.show()},hide:function(){this.$el.hide()},bindEvent:function(){var t=this;i.addListener("onStockReady",function(){t.show()})}},c={init:function(t){return this.cfg=t,this.$el=$("#choose-btn-jnbt"),this.$el.length&&this.bindEvent(),this},isTargetArea:function(){var t=e.getAreaId().areaIds[0];return 1===t},changeArea:function(){var t=this.$el;t.length<1||(this.show(),this.cfg.havestock?this.enabled():this.disabled())},bindEvent:function(){i.addListener("onStockReady",$.proxy(this.changeArea,this));var t=this.$el,e="<p>1. \u70b9\u51fb\u53c2\u52a0\u8282\u80fd\u8865\u8d34\u6309\u94ae\u8d2d\u4e70\uff0c\u6700\u9ad8\u53ef\u51cf\u514d800\u5143\uff01</p>                 <p>2. \u8282\u80fd\u8865\u8d34\u9762\u5411\u5317\u4eac\u5730\u533a\u7684\u7528\u6237\uff0c\u9700\u60a8\u6536\u8d27\u5730\u5740\u4e3a\u5317\u4eac\u4e14\u63d0\u4f9b\u76f8\u5e94\u8bc1\u4ef6\u8bc1\u660e\uff0c                \u6700\u9ad8\u53ef\u4eab\u5546\u54c1\u91d1\u989d13%\u7684\u51cf\u514d\uff08\u4e0a\u9650800\u5143\uff09\uff0c\u5e76\u540c\u65f6\u652f\u6301\u4f7f\u7528\u4eac\u4e1c\u4f18\u60e0\u5238\uff0c                \u70b9\u51fb\u53c2\u52a0\u8282\u80fd\u8865\u8d34\u6309\u94ae\u7acb\u5373\u4f53\u9a8c\uff01</p> ";seajs.use("MOD_ROOT/js/ETooltips",function(){t.ETooltips({close:!1,content:e,width:265,position:"bottom",zIndex:10})})},enabled:function(){this.cfg.havestock?(this.$el.removeClass("btn-disable"),this.$el.attr("href",this.$el.attr("dataurl"))):this.disabled()},disabled:function(){this.$el.addClass("btn-disable").attr("href","#none")},show:function(){this.isTargetArea()?this.$el.show():this.hide()},hide:function(){this.$el.hide()}},l=function(t){var e=$("#btn-dqs"),s="//ding.jd.com/orderPlan/toCreateOrderPlan.action?";i.addListener("onStockReady",function(){t.havestock?e.removeClass("btn-disable"):e.addClass("btn-disable")}),e.show(),e.bind("click",function(){function i(){$("body").dialog({type:"iframe",width:520,height:320,title:"\u5b9a\u671f\u9001",autoIframe:!1,iframeTimestamp:!1,source:s+$.param(e)})}if(!t.havestock)return!1;var e={skuId:t.skuid,buyNum:$(".buy-num").val(),r:Math.random()};require.async(["JDF_UNIT/js/login","JDF_UI/js/dialog"],function(t){t({modal:!0,complete:i})})})};module.exports.__id="buybtn",module.exports.init=t,module.exports.setAmount=setAmount,module.exports.addToCartBtn=u});