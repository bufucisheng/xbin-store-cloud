define("home/widget/seckill",function(require,t,module){"use strict";function i(t,i){var e=i-t.toString().length+1;return Array(+(e>0&&e)).join("0")+t}function e(t){$.extend(this,{startTime:0,endTime:0,$container:null,onSecondPass:function(){},onTimeup:function(){}},t),this.init()}var n=require("conf"),s=require("load_async"),o=require("report");e.prototype={init:function(){this.curentTime=this.startTime||(new Date).getTime(),this.buildDom(),this.getElements(),this.interval=1e3,this.start()},buildDom:function(){var t=this.$container;t.find(".cd").length<=0&&t.append(this.createDom()),t.find(".cd").show()},createDom:function(){var t=[];t.push('<div class="cd clearfix">'),t.push('<div class="cd_item cd_hour">'),t.push('<span class="cd_item_txt">00</span>'),t.push("</div>"),t.push('<div class="cd_split"><i class="cd_split_dot cd_split_top"></i><i class="cd_split_dot cd_split_bottom"></i></div>'),t.push('<div class="cd_item cd_minute">'),t.push('<span class="cd_item_txt">00</span>'),t.push("</div>"),t.push('<div class="cd_split"><i class="cd_split_dot cd_split_top"></i><i class="cd_split_dot cd_split_bottom"></i></div>'),t.push('<div class="cd_item cd_second">'),t.push('<span class="cd_item_txt">00</span>'),t.push("</div>"),t.push("</div>");var i=$(t.join(""));return i},getElements:function(){var t=this.$container;this.$cdHourTxt=t.find(".cd_hour .cd_item_txt"),this.$cdMinuteTxt=t.find(".cd_minute .cd_item_txt"),this.$cdSecondTxt=t.find(".cd_second .cd_item_txt")},start:function(){if(clearTimeout(this.timerId),this.update())return void this.onTimeup.call(this);var t=(new Date).getTime()-this.curentTime;this.curentTime+=this.interval,this.timerId=setTimeout($.proxy(this.start,this),Math.max(0,this.interval-t)),this.onSecondPass.call(this,this.curentTime)},stop:function(){this.endTime=this.curentTime},computeTime:function(t){var i=Math.floor(t/1e3),e=Math.floor(i/3600),n=Math.floor(i%3600/60),s=i%3600%60;return i<=0?0:{hour:e,minute:n,second:s}},update:function(){var t=this.endTime-this.curentTime,e=(this.$container,this.computeTime(t));if(0===e)return!0;var n=e.hour,s=e.minute,o=e.second;this.$cdHourTxt.text(i(n,2)),this.$cdMinuteTxt.text(i(s,2)),this.$cdSecondTxt.text(i(o,2))},reset:function(t,i){t&&i&&i>t&&(this.startTime=t,this.endTime=i,this.start())}};var a=_.Class.extend({construct:function(t){this.conf=$.extend({$el:null,domStr:"",next:function(){}},t),this.init()},init:function(){this.soldRateArr=[],this.$soldProgressBg=null,this.timeRemain=0,this.miaoshaAdvance=0,this.skResult=null,this.isWide=pageConfig.wideVersion,this.loadSk(),this.initEvent()},initEvent:function(){_.eventCenter.on("home:resize",$.proxy(function(t){this.isWide!==t&&(this.isWide=t,this.scroller.reset())},this))},loadSk:function(){var t=this.conf,i=(t.$el,n.INTERFACE.SECKILL),e=n.INTERFACE.SECKILL_BACKUP_PC;return s({url:i,backup:e,params:{isAdvance:0},dataCheck:function(t){return!!(t&&0===parseInt(t.code)&&t.indexMiaoSha&&$.isArray(t.indexMiaoSha)&&t.indexMiaoSha.length>=5&&"string"==typeof t.brandImg&&t.brandImg.length)},jsonpCallback:"jsonpCallbackSeckill",timeout:n.TIMEOUT}).then($.proxy(this.renderSk,this),$.proxy(function(){t.next&&t.next(),this.hideSk()},this))},preloadSk:function(){var t=n.INTERFACE.SECKILL,i=this;return s({url:t,params:{isAdvance:1},jsonpCallback:"jsonpCallbackPreloadSk"}).then(function(t){t&&0===parseInt(t.code)&&t.indexMiaoSha&&t.indexMiaoSha.length&&(i.skResult=t)})},renderSk:function(t){var i=this.conf,e=i.$el,s=window.pageConfig;if(t&&0===parseInt(t.code)&&t.indexMiaoSha&&t.indexMiaoSha.length&&t.indexMiaoSha.length>=5&&t.brandImg&&t.brandImg.length){t.title="XBin秒杀",t.link=n.URLS.MIAOSHA,t.adwords=s.miaoshaAdwords||"好物低价狂欢秒";for(var o=0;o<t.indexMiaoSha.length;o++){var a=t.indexMiaoSha[o],r=a.imageurl,c=a.wareId.match(/(\d)$/)?a.wareId:"11";r=s.replaceMImageUrl(r,c),a.imageurl=s.processImageUrl(r,"260x260","130x130")}var d=t.brandImg;d=s.replaceMImageUrl(d,t.brandId),t.brandImg=s.processImageUrl(d,"360x450","180x225"),this.timeRemain=t.timeRemain,this.miaoshaAdvance=t.miaoshaAdvance;try{var h=require("o2tpl"),l=h(this.conf.domStr,t);e.html(l),i.next&&i.next(),this.initCd(),require.async("home/widget/scroller",$.proxy(function(t){this.initScroller(t)},this))}catch(u){i.next&&i.next(),this.hideSk(),_.console.log(u)}}else i.next&&i.next(),this.hideSk()},hideSk:function(){this.conf.$el.height(0).hide(),o.processHidedFloor(pageConfig.reportFloorHideHash.seckill),_.eventCenter.trigger("render:floorChange","seckill")},initCd:function(){var t=this,i=this.conf.$el,n=i.find(".J_sk_cd_main"),s=t.timeRemain,o=(new Date).getTime();if(s>0){var a=o+1e3*parseInt(s,10);this.cd&&this.cd.stop(),this.cd=new e({$container:n,startTime:o,endTime:a,onSecondPass:function(){--t.timeRemain===t.miaoshaAdvance&&t.preloadSk()},onTimeup:function(){var i=t.skResult;t.skResult?t.renderSk(i):t.loadSk()}})}else $(".J_sk_cd",i).html('<span class="sk_cd_tip">当前场次即将开始</span>')},initScroller:function(t){var i=this.conf.$el.find(".J_sk_list_wrapper");i.length&&(this.scroller=new t({$container:i,$scroller:i.find(".J_sk_list"),scrollItem:".J_sk_item",btnWrapper:".J_sk_controls",nextBtn:".J_sk_control_next",prevBtn:".J_sk_control_prev",itemWidth:200,onInitStyle:function(){this.$container.find(this.btnWrapper).hide()},onMouseEnter:function(t){t.find(this.btnWrapper).show()},onMouseLeave:function(t){t.find(this.btnWrapper).hide()}}))}});return a});