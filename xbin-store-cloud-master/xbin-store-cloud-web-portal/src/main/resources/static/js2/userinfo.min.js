define("home/widget/userinfo",function(require,exports,module){"use strict";var e=require("conf"),i=require("load_async"),r=_.Class.extend({construct:function(e){this.conf=$.extend({$el:null},e),this.init()},init:function(){this.loginDeferred=new $.Deferred,this.getTpl(),this.checkUser(),this.initEvent()},renderDefer:new $.Deferred,initEvent:function(){_.eventCenter.on("home:load",$.proxy(function(){$.when(this.loginDeferred).then($.proxy(function(){this.isLogin&&$.when(pageConfig.userInfoDefer,this.renderDefer).done($.proxy(function(e){var i=e;if(i&&i.imgUrl){var r=i.imgUrl;$(".J_user_info_avatar_img",this.conf.$el).attr("src",r)}},this))},this))},this))},getTpl:function(){var e='        {% var clstagPrefix = pageConfig.clstagPrefix + "09"; %}        <div class="user_info" clstag="{%= clstagPrefix + "a" %}">          <div class="J_user_info_avatar user_info_avatar">              <a href="{%= o.homeUrl %}"><img class="J_user_info_avatar_img" src="{%= o.imgUrl %}" /></a>          </div>          {% if (o.isLogin && o.nickName && o.nickName.length) { %}          <div class="user_info_show">              <p>Hi，<a href="{%= o.homeUrl %}">{%= o.nickName %}</a></p>              <p>                  <a href="{%= o.logoutUrl %}">退出</a>              </p>          </div>          {% } else { %}          <div class="user_info_show">              {% if (o.nickName && o.nickName.length) { %}              <p>Hi，<a href="{%= o.homeUrl %}">{%= o.nickName %}</a></p>              {% } else { %}              <p class="user_info_tip">Hi，欢迎来到XBin！</p>              {% } %}              <p>                  <a href="javascript:login();" class="user_info_login">登录</a>                  <a href="javascript:regist();" class="user_info_reg">注册</a>              </p>          </div>          {% } %}      </div>      <div class="user_profit">        {% if (o.isNew || !o.isLogin) { %}        <a href="{%= o.xinrenUrl %}" target="_blank" clstag="{%= clstagPrefix + "b" %}">新人福利</a>        {% } else { %}        <a href="{%= o.vipUrl %}" target="_blank" clstag="{%= clstagPrefix + "d" %}">XBin会员</a>        {% } %}        <a href="{%= o.plusUrl %}" target="_blank" clstag="{%= clstagPrefix + "c" %}">PLUS会员</a>      </div>';return e},checkNewUser:function(){var r=e.INTERFACE.NEW_USER;return i({url:r,timeout:1e3,jsonpCallback:"jsonpCallbackIsNewuser"})},checkUser:function(){function i(e){var i=require("o2tpl"),o=i(r.getTpl(),e);n.removeClass("mod_loading").html(o),_.eventCenter.trigger("render:userinfo"),t.resolve()}var r=this,n=r.conf.$el,o=e.URLS,t=this.renderDefer,s={homeUrl:o.HOME,loginUrl:o.LOGIN,logoutUrl:o.LOGOUT,registUrl:o.REGIST,xinrenUrl:o.XINREN,vipUrl:o.VIP,isLogin:!1,isNew:!1,plusUrl:o.PLUS,nickName:decodeURIComponent(readCookie("pin")||""),imgUrl:"//misc.360buyimg.com/mtd/pc/common/img/no_login.jpg"};pageConfig.loginDefer.then(function(e){if(e&&e.Identity){var n=e.Identity,o=n.IsAuthenticated;if(o){var t=n.Unick||n.Name;s.isLogin=o,r.isLogin=o,r.loginDeferred.resolve(),r.checkNewUser().then(function(e){if(e){"string"==typeof t&&t.length&&(s.nickName=t);var r=e;"10000"===r.STATE&&(s.isNew=r.isNew),pageConfig.isNewUser=s.isNew,i(s)}else i(s)},function(){i(s)})}else r.loginDeferred.reject(),i(s)}else r.loginDeferred.reject(),i(s)},function(){r.loginDeferred.reject(),i(s)})}});return r});